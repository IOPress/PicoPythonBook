import network
import socket
import rp2
from time import sleep_ms
from machine import Pin, Timer
import onewire
import ds18x20

import ssl

def setup(country, ssid, key):
    rp2.country(country)
    wifi=network.WLAN(network.STA_IF)
    wifi.active(True)
    wifi.disconnect()
    LED=Pin("LED", Pin.OUT)
    LED.high()
    timeout=20000
    wifi.connect(ssid,key)
    timer=Timer()
    timer.init(period=200, mode=Timer.PERIODIC, 
                            callback=lambda t:LED.toggle())
    s=0
    while timeout>0:
        s=wifi.status()
        if s==3 or s<0:
            break
        sleep_ms(100)
        timeout=timeout-100
    
    if(s<2):
        timer.init(period=1000, mode=Timer.PERIODIC,
                            callback=lambda t:LED.toggle())
    else:
        timer.deinit()
        LED.high()
    return wifi

key= b'0\x82\x04\xbc\x02\x01\x000\r\x06\t*\x86H\x86\xf7\r\x01\x01\x01\x05\x00\x04\x82\x04\xa60\x82\x04\xa2\x02\x01\x00\x02\x82\x01\x01\x00\xd6\\\x1e\x81\t\xd6w\x1f\x88\xf8Y\x12m\x96X,X+\x01\xfc\xe5\x01\xe2Y!L\x8a\x8e\x7f\x8c\xfaB\xd7\xd7\xb9\x1c#\xdb\xb3\x1b\x9c\xd9$\x03O\x1b\xcc$c\xee\xf7~\xbcBg\x8f\x84\xc4\x87JWAmL7\x10\xaf\xdc\xd0.\xb7\xbbb![xUZLa\x95\x14\x8b\x12t<\xd8\x14q\xda\xf7!\\us\xf2\xfd\xd6Ux\xd8\xe0{\xb1\x9el\xf5}\xe6\xba\xb8+\xab\xec\xabt];\xf7\xec\xceM+\xba,\xe6\x0bb/x\x8d\x1e\xb0W\x10\xecD\x8c\x94\xb8r\x14RE\xb8I\xe2\x83\x0e\x80i\xff\x0c\xdfR\x83i\xcc\x12\xf1\xa5W,K\xbaI_0\x18\xda\xa1T?T\xe3\xfcJOd\xd5\xb5\xeb\xf4\xd2\r\x17\xac\x15\xfcaS\xc5n\x11\xe1-\xce\x13\xfdH\x0e\x1a\'&h_Hi\xeb\x95> \xffV\xf9@\xb3\xa0l\xa0\xb3\t\x11\xff\xed]\xed\xc6\x97&\xfe\xb1\xbb\'`\x17l0\xc1\xdf\x17J\xa3<\xee\xe2\xdcS\x0b\x8f\xd4\xc6\xa5\xfdR\xd5\x02\x03\x01\x00\x01\x02\x82\x01\x00\x00\xe0\xfa\t\xa3~o\xbf8\xcc\xea\xeb\x19\xc5\xd0\xe7[\xe7\x82\xb3m\x01\xa90\r1\x0c\x17\x81\xe6TO\xffW\xa3\x95\xd3L\x8a\xef})rgL\xde\x93\xe3v<\xf4\xc0^\x1c\xeb?\x8a\x07\xecM\x11\xf9\x136R2\x12\x80^\xb3\xa8\xffFQ\xe6\x97\r\x16\xa9\xe6w\xea\xaed\xf2\x9f\xbf\xb3\x80\xd2\xb9\xf0\xd0\x85\xf9\x9d\x89\x10\xa5\t\xb2\x03d\xa8\x8f\xf1\x98\x83uq/m\x9c#\xf2\xf8\xbb\xbd\xb8Y4p\x95\x96u\x98L\x0c\x02u\xed\xcck\x8c%`S\x12{\xb5\x16\xec\x1b\x90|\x93(\xc7i\xf0\'\xbaD\xe7\xa0\x9c_\xf6\xdd\xea\xa1\x9as\xd4Y\xc3\x00\xe7\x87\xc9\xe8\xe1\x05\x9e\xe9\xa4,A2W\x9d\xe3%:\xfbK\x9a$\xa4\x14k!\xa9\x92\x1ce\x8b\x16\xbf\xba\xe3\x0b\xa2u<\xb7X\xdc\x998\x99\xa4e\x0c\n\xd8\xe1R\x8ds\x1fE\xa6h_t\x88\\\xee&\x12\xc7\xaeG\x98\xd8f\xa6MI\xcf\x18oV\x94\x1f\x9d n\xf6\x87Na\x04\x1a\xe9\x02\x81\x81\x00\xfb\xa1\x91\x1d\xd9\x96\xae\xc0\x0e\x11\xe1\xe1e4>\xef\x87\xf2o\n\x1a\x84\xec \xf0\x91\xe9\x02\xd5!\xb1\x1f\x85\xc00\x1b\xdax\xa7\x13\x80t\xa9\xa2\xd0\xaf\xf9\xb3I\xf9B\x1d\xd0\x07v\xa2b\xe5\xf1\x8e\x80\xd3Bs\xab\r\xb0C\xf3G\xa5\x8f(4\xce\xe7\x03,3\xca\xf3/\xe7D\xee\x02?VD\xb8\xcb<\xfb\x94\xf7D\x972\x9d@\x95\xec\xe1\xab\xdc\xe7\xba\x9f\x80\x08r,\x1e\xff\x92\x93I\xcf\x94\x97E\xc3\xdd\xd6\xf1\xce1\xed\x02\x81\x81\x00\xda\x14\xe43B\xed\x0c\x05B\xc7b\xe0\xfe\x9e\'\xa2\xfa{\x19\x0b\xcf`\x811\xf1\x04]\x93\x06k\xd5as\xd1\x02\xc2"\xf7\xacO\xf5\x1dY\x05\xcdj\r\x814B\xd4\x1d\xad\x0b\xf8*n\x84e\x01\xb4Q\x0f\xec\x9e\xd9\xfbHr\xff\xa6\x06\x10\xe4\xe1\x86J\xbe!T=mT\x83\xa8\x9d\x82d\xddMrx\xfd\xa7A\xcaX\xc0\x99\x9fJQ\x9a\xa9*\xfcN\xc0\t\xb9\x1d\xa6\xb1\xbe\x9fu2\xbfJ\x8b\xff\xf4\x13)\xe5\xff\xa7\x89\x02\x81\x80\x16@\x04\x17\xf2\x9c\x8bY:%D\xa6\xec\x8f\x01\x1d\xa7\x14\xbd\xd2\xd3\xe3{\t\xb2\x9c\x04Q\x96\xcd\x02\xdfy\xb13\xcf\xd2\xb2\xa6{g\xf9h\xe2\x97\xb7g\xc9\xfd\xb9\x87\xaa!1\xf7\xc0\x86$5\x06\xd7\xc7Vq\xe9\xe7,\xf5\xe56)\xa2\x8d\xf8\x95o\x01\xed\xcf\xaa\x9btY\xeb\xd3k\xe9s\xd4a\xce\xbe\xd6\xb4&e/Eox=\x89\x93\xae\xe1\xba\xaf\xda\xd8\xb4f|\x16E\x9d\r_\x12v\xde%r\x1bT\x9dO\x11E\x02\x81\x80\x12U\xcbQ\xdc\x00\x9e\x10\x1b+4O\x02Y=\xaf\xe0+UQ\xbe\xdf\xb8=\x00\xac\x83I\x872\xad\xc0\x01\xc2\xc2\xde\x9b\x9e\x03(\xbd\xcc\xf7\xdd\x1b\x06\x1d\x98\x8dRI\x0f-\xaba\xf3\xffR\xb6CLk\xbcQ\x02\x92\x05$t6\xb68\xb0V\xed\xf7"u\x95\xcb\xc5VY\xd2\xaf\xec~8\x08\xbb(2\xaf\xf0\xce\x01;1\x069t@$&\xb0\xec\x81\x9aw\xb6\xce\x9dc8I\xa3\xca\xdev`\n\xe6\xf4m\x83^\xd91\x02\x81\x80;a\x8a\x01@Py\x08\xd4v\xd57\x0eT`\x1a\xfb\x16+8\xef\xea\x9b\xac\xe9\xc5\x0c\xf1\x828+\x93(@\xf6\x9a!\x827\xcb\x03\x8b\xbeu\xb8\xc7o\xab\xe7"O-\xa49\xd0C:\x0c\xbe\xb0\xf8\x10\x97\x8anv\xf9J.\xb7\xf3\xc5\x0e\xeaL\x05VX\xd4\t\x1dl\xb4da\xday\xd6o\x18\xee+\x16\xa0\xcf\xcep\x8f\xd3\xd2\x85<\x046XdD\x033\xdc#\xe8W\x96\xa9\xbaZ\xc4K\xc3J\x06{\x91\x03g\x1b\x12'

cert= b'0\x82\x02\xfb0\x82\x01\xe3\xa0\x03\x02\x01\x02\x02\x14ko~\xaeq\nG\xa7\x946\x86SD\xa4x\xa5\x15P\xad\xba0\r\x06\t*\x86H\x86\xf7\r\x01\x01\x0b\x05\x000\r1\x0b0\t\x06\x03U\x04\x06\x13\x02AU0\x1e\x17\r250704180243Z\x17\r260704180243Z0\r1\x0b0\t\x06\x03U\x04\x06\x13\x02AU0\x82\x01"0\r\x06\t*\x86H\x86\xf7\r\x01\x01\x01\x05\x00\x03\x82\x01\x0f\x000\x82\x01\n\x02\x82\x01\x01\x00\xd6\\\x1e\x81\t\xd6w\x1f\x88\xf8Y\x12m\x96X,X+\x01\xfc\xe5\x01\xe2Y!L\x8a\x8e\x7f\x8c\xfaB\xd7\xd7\xb9\x1c#\xdb\xb3\x1b\x9c\xd9$\x03O\x1b\xcc$c\xee\xf7~\xbcBg\x8f\x84\xc4\x87JWAmL7\x10\xaf\xdc\xd0.\xb7\xbbb![xUZLa\x95\x14\x8b\x12t<\xd8\x14q\xda\xf7!\\us\xf2\xfd\xd6Ux\xd8\xe0{\xb1\x9el\xf5}\xe6\xba\xb8+\xab\xec\xabt];\xf7\xec\xceM+\xba,\xe6\x0bb/x\x8d\x1e\xb0W\x10\xecD\x8c\x94\xb8r\x14RE\xb8I\xe2\x83\x0e\x80i\xff\x0c\xdfR\x83i\xcc\x12\xf1\xa5W,K\xbaI_0\x18\xda\xa1T?T\xe3\xfcJOd\xd5\xb5\xeb\xf4\xd2\r\x17\xac\x15\xfcaS\xc5n\x11\xe1-\xce\x13\xfdH\x0e\x1a\'&h_Hi\xeb\x95> \xffV\xf9@\xb3\xa0l\xa0\xb3\t\x11\xff\xed]\xed\xc6\x97&\xfe\xb1\xbb\'`\x17l0\xc1\xdf\x17J\xa3<\xee\xe2\xdcS\x0b\x8f\xd4\xc6\xa5\xfdR\xd5\x02\x03\x01\x00\x01\xa3S0Q0\x1d\x06\x03U\x1d\x0e\x04\x16\x04\x14\x94ow\x81Z\x8d\xa7\xa3\xed:\x93\x06\xe4\xba~\x13-2\xcf\xeb0\x1f\x06\x03U\x1d#\x04\x180\x16\x80\x14\x94ow\x81Z\x8d\xa7\xa3\xed:\x93\x06\xe4\xba~\x13-2\xcf\xeb0\x0f\x06\x03U\x1d\x13\x01\x01\xff\x04\x050\x03\x01\x01\xff0\r\x06\t*\x86H\x86\xf7\r\x01\x01\x0b\x05\x00\x03\x82\x01\x01\x00:5;X\x17v\x95\xd0\x13\x8b\xa5>G@\x86$Byv\xed,Pz$\x1fG\x08\xe6x_\x80(\x06J21\x9a\x95\xfaMB\x9c\x83\xedX\x90*R\xb4{\x83\xb2\xea\xd76\xd3\xec\x96\x11\x0f@\xb3v\xb2\x11\xac\x91z\x1f\xb7n_}\xd6\x07Tg\xf73(*\x8dSFZZ\x15\xb7\x1b\xbay\xeb\xaf\x81\xe7\x1aXE\x0fk\xf6\x1e*\xd0\x16}\xa6\xe0\xe2g\xce\x10\xc2iPq\xc4k\xfd\xac\x85\x12\x13\xb3\xcc~\x10\x05\x1e\xbeL3\xbf(\x90\x96\x18\xa4\x81\x0c\x1e\x11\x1b\xde\xf8N\xd0T\x90\x8c\xba\xa1+Z\xeaN\x85\x9a\xd7\x82\xa5\xe1\xde\x0c\xac\xc1+\xfaq\x9dj\x08\x1bZ\xa8\x0eCI0P<\xd2\xb2\x06\x929\xc5\xde\xd9\x9a\xa5\x88\xe7$\x13\x9a!\xfe\xda_\xc9\xbd\xc1\x9b\xe1\xdd\x86\xe8\xa1\xa9\x94\x8a\xe2#&\x808\xee\xb6\xc7\x13&i\x1bg&&\xa0]n\x10\xa4\xb6_\x027\xf8/\x14\xec\x16;\x14\x8f]\xcb\xbeU\x82\xb4O \xc0\xfcF\x1e'

wifi = setup("country", "ssid", "key")
print(wifi.ifconfig())

ow = onewire.OneWire(Pin(2))
presence = ow.reset()
if presence:
 print("Device present")
else:
 print("No device")

DS = ds18x20.DS18X20(ow)
roms = DS.scan()


template = """<!DOCTYPE html>
<html>
<head> <title>Temperature</title> </head>
<body> <h1>Current Temperature</h1>
Hello Pico W Server World <br/>
The Temperature is: <!--#temp--><br/>
</body>
</html>
"""

addr = socket.getaddrinfo('0.0.0.0', 443)[0][-1]

s = socket.socket()
s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
s.bind(addr)
s.listen(5)

while True:
    cl, addr = s.accept()
    print('client connected from', addr)
    client_s =None
    
    try:
        client_s = ssl.wrap_socket(cl, server_side=True, 
                                          key=key, cert=cert)

        while True:
            h = client_s.readline()
            if h == b"" or h == b"\r\n":
                    break
            print(h.decode(), end="")

        temp = DS.read_temp(roms[0])
        
        html=template.replace("<!--#temp-->",str(temp))
        headers = ("HTTP/1.1 200 OK\r\n"
                "Content-Type: text/html; charset=UTF-8\r\n"
                "Server:Pico\r\n"
                f"Content-Length:{len(html)}\r\n\r\n"
                )
        buf = headers.encode("utf-8")+html.encode("utf-8")

        client_s.write(buf)

        client_s.close()
    except Exception as e:
       print("exception ",e)

s.close()